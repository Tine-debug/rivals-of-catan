<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Server.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">principia-tests</a> &gt; <a href="index.source.html" class="el_package">default</a> &gt; <span class="el_source">Server.java</span></div><h1>Server.java</h1><pre class="source lang-java linenums">// Server.java
// Single-process server/loop (no networking). Introductory game only.

import java.net.ServerSocket;
import java.net.Socket;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.*;

<span class="fc" id="L10">public class Server {</span>

<span class="fc" id="L12">    public final List&lt;Player&gt; players = new ArrayList&lt;&gt;();</span>
    public ServerSocket serverSocket;
<span class="fc" id="L14">    private final Random rng = new Random();</span>

    // Production helpers
<span class="fc" id="L17">    private static final Map&lt;String, String&gt; REGION_TO_RESOURCE = Map.of(</span>
            &quot;Forest&quot;, &quot;Lumber&quot;,
            &quot;Field&quot;, &quot;Grain&quot;,
            &quot;Pasture&quot;, &quot;Wool&quot;,
            &quot;Hill&quot;, &quot;Brick&quot;,
            &quot;Mountain&quot;, &quot;Ore&quot;,
            &quot;Gold Field&quot;, &quot;Gold&quot;);

    // Event die faces
    private static final int EV_BRIGAND = 1;
    private static final int EV_TRADE = 2;
    private static final int EV_CELEB = 3;
    private static final int EV_PLENTY = 4;
    private static final int EV_EVENT_A = 5;
    private static final int EV_EVENT_B = 6;

    // ---------- Bootstrap ----------
    public static void main(String[] args) {
<span class="nc" id="L35">        Server s = new Server();</span>
        try {
<span class="nc bnc" id="L37" title="All 6 branches missed.">            if ((args.length == 0 || (args.length &gt; 0 &amp;&amp; args[0].equalsIgnoreCase(&quot;bot&quot;)))) {</span>
<span class="nc" id="L38">                Card.loadBasicCards(&quot;cards.json&quot;);</span>
<span class="nc bnc" id="L39" title="All 2 branches missed.">                s.start(args.length == 0 ? false : true); // with bot</span>
<span class="nc" id="L40">                s.run();</span>
<span class="nc" id="L41">                return;</span>
<span class="nc bnc" id="L42" title="All 4 branches missed.">            } else if (args.length &gt; 0 &amp;&amp; args[0].equalsIgnoreCase(&quot;online&quot;)) {</span>
<span class="nc" id="L43">                s.runClient();</span>
<span class="nc" id="L44">                return; // run client mode</span>
            } else {
<span class="nc" id="L46">                System.out.println(&quot;Usage: java Server [optional: bot|online]&quot;);</span>
<span class="nc" id="L47">                return;</span>
            }
<span class="nc" id="L49">        } catch (Exception e) {</span>
<span class="nc" id="L50">            System.err.println(&quot;Failed to start: &quot; + e.getMessage());</span>
<span class="nc" id="L51">            return;</span>
        }
    }

    public void start(boolean withBot) throws Exception {
        // 1) local console player
<span class="nc" id="L57">        players.add(new Player());</span>
        // 2) bot player
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (withBot) {</span>
<span class="nc" id="L60">            Player bot = new Player();</span>
<span class="nc" id="L61">            bot.isBot = true;</span>
<span class="nc" id="L62">            players.add(bot);</span>
<span class="nc" id="L63">        }</span>
        // 3) networked players
        else {
<span class="nc" id="L66">            serverSocket = new ServerSocket(2048);</span>
<span class="nc" id="L67">            Socket sock = serverSocket.accept();</span>
<span class="nc" id="L68">            ObjectOutputStream out = new ObjectOutputStream(sock.getOutputStream());</span>
<span class="nc" id="L69">            ObjectInputStream in = new ObjectInputStream(sock.getInputStream());</span>
            // Use your existing OnlinePlayer class for remote players:
<span class="nc" id="L71">            OnlinePlayer op = new OnlinePlayer();</span>
            // Then wire up its socket streams directly:
<span class="nc" id="L73">            op.setConnection(sock, in, out);</span>
<span class="nc" id="L74">            players.add(op);</span>
<span class="nc" id="L75">            System.out.println(&quot;Connected Online Player &quot;);</span>
<span class="nc" id="L76">            op.sendMessage(&quot;WELCOME Online Player &quot;);</span>
        }
<span class="nc" id="L78">        initPrincipality();</span>
        // Initial replenish (3 cards each)
<span class="nc bnc" id="L80" title="All 2 branches missed.">        for (int i = 0; i &lt; players.size(); i++) {</span>
<span class="nc" id="L81">            replenish(players.get(i));</span>
        }
<span class="nc" id="L83">    }</span>

    public void runClient() throws Exception {
<span class="nc" id="L86">        Socket socket = new Socket(&quot;127.0.0.1&quot;, 2048);</span>

        // IMPORTANT: create ObjectOutputStream first, then flush, then
        // ObjectInputStream
<span class="nc" id="L90">        ObjectOutputStream outToServer = new ObjectOutputStream(socket.getOutputStream());</span>
<span class="nc" id="L91">        outToServer.flush(); // send stream header immediately</span>
<span class="nc" id="L92">        ObjectInputStream inFromServer = new ObjectInputStream(socket.getInputStream());</span>

<span class="nc" id="L94">        Scanner console = new Scanner(System.in);</span>
        try {
            while (true) {
<span class="nc" id="L97">                Object obj = inFromServer.readObject();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (!(obj instanceof String)) {</span>
                    // ignore unexpected payloads
<span class="nc" id="L100">                    continue;</span>
                }
<span class="nc" id="L102">                String msg = (String) obj;</span>

                // Always print what the server sent
<span class="nc" id="L105">                System.out.println(msg);</span>

                // If it's a prompt, read one line from console and send it back
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (msg.startsWith(&quot;PROMPT:&quot;)) {</span>
<span class="nc" id="L109">                    System.out.print(&quot;&gt; &quot;);</span>
<span class="nc" id="L110">                    System.out.flush();</span>
<span class="nc" id="L111">                    String answer = console.nextLine();</span>
<span class="nc" id="L112">                    outToServer.writeObject(answer);</span>
<span class="nc" id="L113">                    outToServer.flush(); // push it now</span>
<span class="nc" id="L114">                    outToServer.reset(); // avoid OOS caching of repeated String instances</span>
                }

                // Allow server to end the session with a keyword
<span class="nc bnc" id="L118" title="All 4 branches missed.">                if (msg.toLowerCase().contains(&quot;winner&quot;) || msg.equalsIgnoreCase(&quot;CLOSE&quot;))</span>
<span class="nc" id="L119">                    break;</span>
<span class="nc" id="L120">            }</span>
        } finally {
            try {
<span class="nc" id="L123">                console.close();</span>
<span class="nc" id="L124">                inFromServer.close();</span>
<span class="nc" id="L125">                outToServer.close();</span>
<span class="nc" id="L126">                socket.close();</span>
<span class="nc" id="L127">            } catch (Exception ignored) {</span>
<span class="nc" id="L128">            }</span>
        }
<span class="nc" id="L130">    }</span>

    // ---------- Initial setup (your original layout preserved) ----------
    private void initPrincipality() {
        // Center row index = 2 in a 5x5
<span class="fc" id="L135">        int center = 2;</span>

        // Two players’ starting diceRoll sets (Forest, Gold Field, Field, Hill,
        // Pasture, Mountain)
<span class="fc" id="L139">        int[][] regionDice = { { 2, 1, 6, 3, 4, 5 }, { 3, 4, 5, 2, 1, 6 } };</span>

<span class="fc bfc" id="L141" title="All 2 branches covered.">        for (int i = 0; i &lt; players.size(); i++) {</span>
<span class="fc" id="L142">            Player p = players.get(i);</span>
            // center basics
<span class="fc" id="L144">            p.placeCard(center, 1, Card.popCardByName(Card.settlements, &quot;Settlement&quot;));</span>
<span class="fc" id="L145">            p.placeCard(center, 2, Card.popCardByName(Card.roads, &quot;Road&quot;));</span>
<span class="fc" id="L146">            p.placeCard(center, 3, Card.popCardByName(Card.settlements, &quot;Settlement&quot;));</span>

            // Regions in rows 1 and 3 (above/below)
<span class="fc" id="L149">            Card forest = Card.popCardByName(Card.regions, &quot;Forest&quot;);</span>
<span class="fc" id="L150">            forest.diceRoll = regionDice[i][0];</span>
<span class="fc" id="L151">            forest.regionProduction = 1;</span>
<span class="fc" id="L152">            Card gold = Card.popCardByName(Card.regions, &quot;Gold Field&quot;);</span>
<span class="fc" id="L153">            gold.diceRoll = regionDice[i][1];</span>
<span class="fc" id="L154">            gold.regionProduction = 0;</span>
<span class="fc" id="L155">            Card field = Card.popCardByName(Card.regions, &quot;Field&quot;);</span>
<span class="fc" id="L156">            field.diceRoll = regionDice[i][2];</span>
<span class="fc" id="L157">            field.regionProduction = 1;</span>
<span class="fc" id="L158">            Card hill = Card.popCardByName(Card.regions, &quot;Hill&quot;);</span>
<span class="fc" id="L159">            hill.diceRoll = regionDice[i][3];</span>
<span class="fc" id="L160">            hill.regionProduction = 1;</span>
<span class="fc" id="L161">            Card past = Card.popCardByName(Card.regions, &quot;Pasture&quot;);</span>
<span class="fc" id="L162">            past.diceRoll = regionDice[i][4];</span>
<span class="fc" id="L163">            past.regionProduction = 1;</span>
<span class="fc" id="L164">            Card mount = Card.popCardByName(Card.regions, &quot;Mountain&quot;);</span>
<span class="fc" id="L165">            mount.diceRoll = regionDice[i][5];</span>
<span class="fc" id="L166">            mount.regionProduction = 1;</span>

<span class="fc" id="L168">            p.placeCard(center - 1, 0, forest);</span>
<span class="fc" id="L169">            p.placeCard(center - 1, 2, gold);</span>
<span class="fc" id="L170">            p.placeCard(center - 1, 4, field);</span>
<span class="fc" id="L171">            p.placeCard(center + 1, 0, hill);</span>
<span class="fc" id="L172">            p.placeCard(center + 1, 2, past);</span>
<span class="fc" id="L173">            p.placeCard(center + 1, 4, mount);</span>

        }

        // Put remaining “fixed dice” regions back in region stack (as in your previous
        // code)
<span class="fc" id="L179">        addBackExtraFixedRegions();</span>
<span class="fc" id="L180">        Collections.shuffle(Card.regions);</span>
<span class="fc" id="L181">    }</span>

    private void addBackExtraFixedRegions() {
        // There are two of each of these cards, each with a fixed diceRoll:
<span class="fc" id="L185">        setTwoUndiced(&quot;Field&quot;, 3, 1);</span>
<span class="fc" id="L186">        setTwoUndiced(&quot;Mountain&quot;, 4, 2);</span>
<span class="fc" id="L187">        setTwoUndiced(&quot;Hill&quot;, 5, 1);</span>
<span class="fc" id="L188">        setTwoUndiced(&quot;Forest&quot;, 6, 4);</span>
<span class="fc" id="L189">        setTwoUndiced(&quot;Pasture&quot;, 6, 5);</span>
<span class="fc" id="L190">        setTwoUndiced(&quot;Gold Field&quot;, 3, 2);</span>

        // After assigning dice to remaining cards, shuffle the deck
<span class="fc" id="L193">        java.util.Collections.shuffle(Card.regions);</span>
<span class="fc" id="L194">    }</span>

    private void setTwoUndiced(String name, int d1, int d2) {
<span class="fc" id="L197">        Card c1 = findUndicedByName(Card.regions, name);</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">        if (c1 != null)</span>
<span class="fc" id="L199">            c1.diceRoll = d1;</span>
<span class="fc" id="L200">        Card c2 = findUndicedByName(Card.regions, name);</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">        if (c2 != null)</span>
<span class="fc" id="L202">            c2.diceRoll = d2;</span>
<span class="fc" id="L203">    }</span>

    // Returns a card with diceRoll == 0, matching name, but DOES NOT remove it.
    private Card findUndicedByName(java.util.Vector&lt;Card&gt; deck, String name) {
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        for (int i = 0; i &lt; deck.size(); i++) {</span>
<span class="fc" id="L208">            Card c = deck.get(i);</span>
<span class="pc bpc" id="L209" title="1 of 6 branches missed.">            if (c != null &amp;&amp; name.equalsIgnoreCase(c.name) &amp;&amp; c.diceRoll == 0) {</span>
<span class="fc" id="L210">                return c; // leave in place; we only set diceRoll</span>
            }
        }
<span class="nc" id="L213">        return null;</span>
    }

    // ---------- Main loop ----------
    public void run() {
<span class="nc bnc" id="L218" title="All 2 branches missed.">        int current = Math.random() &lt; 0.5 ? 0 : 1; // random start</span>
        // print the players principality and hand
<span class="nc bnc" id="L220" title="All 2 branches missed.">        for (int i = 0; i &lt; players.size(); i++) {</span>
<span class="nc" id="L221">            players.get(i).sendMessage(&quot;Opponent's starting board:&quot;);</span>
<span class="nc" id="L222">            players.get(i).sendMessage(</span>
<span class="nc" id="L223">                    &quot;\t\t&quot; + players.get((i + 1) % players.size()).printPrincipality().replace(&quot;\n&quot;, &quot;\n\t\t&quot;));</span>
<span class="nc" id="L224">            players.get(i).sendMessage(&quot;Your starting board:&quot;);</span>
<span class="nc" id="L225">            players.get(i).sendMessage(players.get(i).printPrincipality());</span>
<span class="nc" id="L226">            players.get(i).sendMessage(&quot;Your starting hand:&quot;);</span>
<span class="nc" id="L227">            players.get(i).sendMessage(players.get(i).printHand());</span>
        }
        while (true) {
<span class="nc" id="L230">            Player active = players.get(current);</span>
<span class="nc" id="L231">            Player other = players.get((current + 1) % players.size());</span>

            // -------- Part 1: Roll Dice --------
<span class="nc" id="L234">            int eventFace = rollEventDie(active);</span>
<span class="nc" id="L235">            int prodFace = rollProductionDie(active);</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (eventFace == EV_BRIGAND) { // Brigand first, then production</span>
<span class="nc" id="L238">                resolveEvent(eventFace, active, other);</span>
<span class="nc" id="L239">                applyProduction(prodFace); // regions + boosters (cap 3)</span>
            } else { // production first, then event
<span class="nc" id="L241">                applyProduction(prodFace); // regions + boosters (cap 3)</span>
<span class="nc" id="L242">                resolveEvent(eventFace, active, other);</span>
            }

            // print the players principality and hand
<span class="nc bnc" id="L246" title="All 2 branches missed.">            for (int i = 0; i &lt; players.size(); i++) {</span>
<span class="nc" id="L247">                players.get(i).sendMessage(&quot;Opponent's board:&quot;);</span>
<span class="nc" id="L248">                players.get(i).sendMessage(</span>
<span class="nc" id="L249">                        &quot;\t\t&quot; + players.get((i + 1) % players.size()).printPrincipality().replace(&quot;\n&quot;, &quot;\n\t\t&quot;));</span>
<span class="nc" id="L250">                players.get(i).sendMessage(&quot;Your board:&quot;);</span>
<span class="nc" id="L251">                players.get(i).sendMessage(players.get(i).printPrincipality());</span>
<span class="nc" id="L252">                players.get(i).sendMessage(&quot;Your hand:&quot;);</span>
<span class="nc" id="L253">                players.get(i).sendMessage(players.get(i).printHand());</span>
            }

            // -------- Part 2: Action Phase (very small) --------
<span class="nc" id="L257">            actionPhase(active, other);</span>

            // -------- Part 3: Replenish Hand --------
<span class="nc" id="L260">            replenish(active);</span>

            // -------- Part 4: Exchange (simplified) --------
<span class="nc" id="L263">            exchangePhase(active);</span>

            // -------- Part 5: Scoring &amp; Win Check --------
<span class="nc bnc" id="L266" title="All 2 branches missed.">            if (checkWinEndOfTurn(active, other))</span>
<span class="nc" id="L267">                break;</span>

<span class="nc" id="L269">            current = (current + 1) % players.size();</span>
<span class="nc" id="L270">        }</span>
<span class="nc" id="L271">    }</span>

    private boolean checkWinEndOfTurn(Player active, Player other) {
<span class="nc" id="L274">        int score = active.currentScoreAgainst(other);</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">        if (score &gt;= 7) {</span>
<span class="nc" id="L276">            broadcast(&quot;winner: Player &quot; + players.indexOf(active)</span>
                    + &quot; wins with &quot; + score + &quot; VP (incl. advantage tokens)!&quot;);
<span class="nc" id="L278">            return true;</span>
        }
<span class="nc" id="L280">        return false;</span>
    }

    // ---------- Dice ----------
    private int rollEventDie(Player active) {
        // Brigitta lets the player fix production die, not event die — but we keep the
        // hook simple
<span class="nc" id="L287">        int face = 1 + rng.nextInt(6);</span>
<span class="nc" id="L288">        broadcast(&quot;[EventDie] -&gt; &quot; + face);</span>
<span class="nc" id="L289">        return face;</span>
    }

    private int rollProductionDie(Player active) {
<span class="nc" id="L293">        int face = 1 + rng.nextInt(6);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (active.flags.contains(&quot;BRIGITTA&quot;)) {</span>
<span class="nc" id="L295">            active.sendMessage(&quot;PROMPT: Brigitta active -  choose production die [1-6]:&quot;);</span>
            try {
<span class="nc" id="L297">                int forced = Integer.parseInt(active.receiveMessage().trim());</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">                if (forced &gt;= 1 &amp;&amp; forced &lt;= 6)</span>
<span class="nc" id="L299">                    face = forced;</span>
<span class="nc" id="L300">            } catch (Exception ignored) {</span>
<span class="nc" id="L301">            }</span>
<span class="nc" id="L302">            active.flags.remove(&quot;BRIGITTA&quot;);</span>
        }
<span class="nc" id="L304">        broadcast(&quot;[ProductionDie] -&gt; &quot; + face);</span>
<span class="nc" id="L305">        return face;</span>
    }

    // ---------- Production ----------
    private void applyProduction(int face) {
<span class="nc bnc" id="L310" title="All 2 branches missed.">        for (Player p : players) {</span>
            // Marketplace extra check: if opponent has more regions matching face, p gets
            // +1 of matching type (your rule text)
<span class="nc" id="L313">            boolean hasMarketplace = p.flags.contains(&quot;MARKETPLACE&quot;);</span>
<span class="nc" id="L314">            int pMatches = countFaceRegions(p, face);</span>
<span class="nc" id="L315">            int oppMatches = countFaceRegions(opponentOf(p), face);</span>

<span class="nc bnc" id="L317" title="All 2 branches missed.">            for (int r = 0; r &lt; p.principality.size(); r++) {</span>
<span class="nc" id="L318">                List&lt;Card&gt; row = p.principality.get(r);</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                for (int c = 0; c &lt; row.size(); c++) {</span>
<span class="nc" id="L320">                    Card card = row.get(c);</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">                    if (card == null || !&quot;Region&quot;.equalsIgnoreCase(card.type))</span>
<span class="nc" id="L322">                        continue;</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">                    if (card.diceRoll != face)</span>
<span class="nc" id="L324">                        continue;</span>

                    // Base increase = 1
<span class="nc" id="L327">                    int inc = 1;</span>
                    // Booster buildings adjacent (same row, at c-1 or c+1) add +1 (the “double”
                    // effect)
<span class="nc bnc" id="L330" title="All 2 branches missed.">                    if (hasAdjacentBoosterForRegion(p, r, c))</span>
<span class="nc" id="L331">                        inc += 1;</span>

<span class="nc" id="L333">                    card.regionProduction = Math.min(3, card.regionProduction + inc);</span>
                }
            }

            // Marketplace: if opponent has strictly more face-regions than p, p may gain +1
            // of one of those face resources
<span class="nc bnc" id="L339" title="All 4 branches missed.">            if (hasMarketplace &amp;&amp; oppMatches &gt; pMatches) {</span>
<span class="nc" id="L340">                p.sendMessage(&quot;PROMPT: Marketplace - choose one resource produced on face &quot; + face</span>
                        + &quot; to gain (e.g., Grain/Gold/Lumber):&quot;);
<span class="nc" id="L342">                String res = p.receiveMessage();</span>
<span class="nc" id="L343">                p.gainResource(res);</span>
            }

            // Toll Bridge: on Plentiful Harvest handled in event, not here
<span class="nc" id="L347">        }</span>
<span class="nc" id="L348">    }</span>

    private boolean hasAdjacentBoosterForRegion(Player p, int rr, int cc) {
<span class="nc" id="L351">        Card region = p.getCard(rr, cc);</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (region == null)</span>
<span class="nc" id="L353">            return false;</span>
        // Check building at (rr, cc-1) and (rr, cc+1)
<span class="nc" id="L355">        Card left = p.getCard(rr, cc - 1);</span>
<span class="nc" id="L356">        Card right = p.getCard(rr, cc + 1);</span>
<span class="nc bnc" id="L357" title="All 4 branches missed.">        return isBoosting(left, region) || isBoosting(right, region);</span>
    }

    private boolean isBoosting(Card maybeBuilding, Card region) {
<span class="nc bnc" id="L361" title="All 2 branches missed.">        if (maybeBuilding == null)</span>
<span class="nc" id="L362">            return false;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (!&quot;Building&quot;.equalsIgnoreCase(maybeBuilding.type))</span>
<span class="nc" id="L364">            return false;</span>
<span class="nc" id="L365">        return Card.buildingBoostsRegion(maybeBuilding.name, region.name);</span>
    }

    private int countFaceRegions(Player p, int face) {
<span class="nc" id="L369">        int n = 0;</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">        for (List&lt;Card&gt; row : p.principality)</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">            for (Card c : row)</span>
<span class="nc bnc" id="L372" title="All 6 branches missed.">                if (c != null &amp;&amp; &quot;Region&quot;.equalsIgnoreCase(c.type) &amp;&amp; c.diceRoll == face)</span>
<span class="nc" id="L373">                    n++;</span>
<span class="nc" id="L374">        return n;</span>
    }

    // ---------- Events ----------
    private void resolveEvent(int face, Player active, Player other) {
<span class="pc bpc" id="L379" title="2 of 6 branches missed.">        switch (face) {</span>
            case EV_BRIGAND:
<span class="fc" id="L381">                broadcast(&quot;[Event] Brigand Attack&quot;);</span>
                // Count total of Gold+Wool across regions, excluding regions adjacent to
                // storehouse
<span class="fc bfc" id="L384" title="All 2 branches covered.">                for (Player p : players) {</span>
<span class="fc" id="L385">                    int total = countGoldAndWool(p, true);</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">                    if (total &gt; 7) {</span>
                        // zero out Gold+Wool production for impacted regions (except excluded)
<span class="fc" id="L388">                        zeroGoldAndWool(p, true);</span>
<span class="fc" id="L389">                        p.sendMessage(&quot;Brigands! You lose all Gold &amp; Wool in affected regions.&quot;);</span>
                    }
<span class="fc" id="L391">                }</span>
<span class="fc" id="L392">                break;</span>

            case EV_TRADE:
<span class="fc" id="L395">                broadcast(&quot;[Event] Trade&quot;);</span>
                // Player with Trade Advantage (&gt;=3 commerce) gains 1 resource of choice from
                // bank
<span class="fc bfc" id="L398" title="All 2 branches covered.">                for (Player p : players) {</span>
<span class="fc bfc" id="L399" title="All 2 branches covered.">                    if (p.commercePoints &gt;= 3) {</span>
<span class="fc" id="L400">                        p.sendMessage(</span>
                                &quot;PROMPT: Trade Advantage - gain 1 resource of your choice [Brick|Grain|Lumber|Wool|Ore|Gold]:&quot;);
<span class="fc" id="L402">                        p.gainResource(p.receiveMessage());</span>
                    }
<span class="fc" id="L404">                }</span>
<span class="fc" id="L405">                break;</span>

            case EV_CELEB:
<span class="fc" id="L408">                broadcast(&quot;[Event] Celebration&quot;);</span>
<span class="fc" id="L409">                int aSP = players.get(0).skillPoints;</span>
<span class="fc" id="L410">                int bSP = players.get(1).skillPoints;</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">                if (aSP == bSP) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">                    for (Player p : players) {</span>
<span class="nc" id="L413">                        p.sendMessage(</span>
                                &quot;PROMPT: Celebration - gain 1 resource of your choice [Brick|Grain|Lumber|Wool|Ore|Gold]:&quot;);
<span class="nc" id="L415">                        p.gainResource(p.receiveMessage());</span>
<span class="nc" id="L416">                    }</span>
                } else {
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">                    Player winner = aSP &gt; bSP ? players.get(0) : players.get(1);</span>
<span class="fc" id="L419">                    winner.sendMessage(</span>
                            &quot;PROMPT: Celebration (you have most skill) - gain 1 resource of your choice [Brick|Grain|Lumber|Wool|Ore|Gold]:&quot;);
<span class="fc" id="L421">                    winner.gainResource(winner.receiveMessage());</span>
                }
<span class="fc" id="L423">                break;</span>

            case EV_PLENTY:
<span class="fc" id="L426">                broadcast(&quot;[Event] Plentiful Harvest: each player gains 1 of choice.&quot;);</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">                for (Player p : players) {</span>
<span class="fc" id="L428">                    p.sendMessage(&quot;PROMPT: Plentiful Harvest - choose a resource [Brick|Grain|Lumber|Wool|Ore|Gold]:&quot;);</span>
<span class="fc" id="L429">                    p.gainResource(p.receiveMessage());</span>
                    // Toll Bridge: +2 Gold if you can store it (any gold field with &lt;3)
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">                    if (p.flags.contains(&quot;TOLLB&quot;)) {</span>
<span class="nc" id="L432">                        int add = grantGoldIfSpace(p, 2);</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">                        if (add &gt; 0)</span>
<span class="nc" id="L434">                            p.sendMessage(&quot;Toll Bridge: +&quot; + add + &quot; Gold&quot;);</span>
                    }
<span class="fc" id="L436">                }</span>
<span class="fc" id="L437">                break;</span>

            case EV_EVENT_A:
            case EV_EVENT_B: {
<span class="nc" id="L441">                broadcast(&quot;[Event] Draw Event Card&quot;);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">                if (Card.events.isEmpty()) {</span>
<span class="nc" id="L443">                    broadcast(&quot;Event deck empty.&quot;);</span>
<span class="nc" id="L444">                    break;</span>
                }
<span class="nc" id="L446">                Card top = Card.events.remove(0);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">                broadcast(&quot;EVENT: &quot; + (top.cardText != null ? top.cardText : top.name));</span>

<span class="nc bnc" id="L449" title="All 2 branches missed.">                String nm = (top.name == null ? &quot;&quot; : top.name).toLowerCase();</span>

<span class="nc bnc" id="L451" title="All 2 branches missed.">                if (nm.equalsIgnoreCase(&quot;feud&quot;)) {</span>
<span class="nc" id="L452">                    resolveFeud(active, other);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                } else if (nm.equalsIgnoreCase(&quot;fraternal feuds&quot;)) {</span>
<span class="nc" id="L454">                    resolveFraternalFeuds(active, other);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">                } else if (nm.equalsIgnoreCase(&quot;invention&quot;)) {</span>
<span class="nc" id="L456">                    resolveInvention();</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">                } else if (nm.equalsIgnoreCase(&quot;trade ships race&quot;)) {</span>
<span class="nc" id="L458">                    resolveTradeShipsRace();</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">                } else if (nm.equalsIgnoreCase(&quot;traveling merchant&quot;)) {</span>
<span class="nc" id="L460">                    resolveTravelingMerchant();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                } else if (nm.equalsIgnoreCase(&quot;year of plenty&quot;)) {</span>
<span class="nc" id="L462">                    resolveYearOfPlenty();</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                } else if (nm.equalsIgnoreCase(&quot;yule&quot;)) {</span>
                    // Shuffle the event deck and immediately draw again
<span class="nc" id="L465">                    java.util.Collections.shuffle(Card.events);</span>
<span class="nc" id="L466">                    resolveEvent(EV_EVENT_A, active, other); // recurse one more draw</span>
                }
                break;
            }
            default:
<span class="nc" id="L471">                broadcast(&quot;[Event] Unknown face &quot; + face);</span>
        }
<span class="fc" id="L473">    }</span>

    private void resolveFeud(Player active, Player other) {
        // Decide who (if any) has strength advantage
<span class="nc bnc" id="L477" title="All 2 branches missed.">        Player adv = hasStrengthAdvantage(players.get(0), players.get(1)) ? players.get(0)</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">                : hasStrengthAdvantage(players.get(1), players.get(0)) ? players.get(1)</span>
<span class="nc" id="L479">                        : null;</span>

<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (adv == null) {</span>
<span class="nc" id="L482">            broadcast(&quot;Feud: no strength advantage; nothing happens.&quot;);</span>
<span class="nc" id="L483">            return;</span>
        }

<span class="nc bnc" id="L486" title="All 2 branches missed.">        Player opp = (adv == players.get(0)) ? players.get(1) : players.get(0);</span>

        // Collect opponent buildings (type == &quot;Building&quot;)
<span class="nc" id="L489">        java.util.List&lt;int[]&gt; buildings = new java.util.ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">        for (int r = 0; r &lt; opp.principality.size(); r++) {</span>
<span class="nc" id="L491">            var row = opp.principality.get(r);</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">            for (int c = 0; c &lt; row.size(); c++) {</span>
<span class="nc" id="L493">                Card x = row.get(c);</span>
<span class="nc bnc" id="L494" title="All 6 branches missed.">                if (x != null &amp;&amp; x.type != null &amp;&amp; x.type.equalsIgnoreCase(&quot;Building&quot;)) {</span>
<span class="nc" id="L495">                    buildings.add(new int[] { r, c });</span>
                }
            }
        }
<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (buildings.isEmpty()) {</span>
<span class="nc" id="L500">            broadcast(&quot;Feud: opponent has no buildings.&quot;);</span>
<span class="nc" id="L501">            return;</span>
        }

        // Ask advantage player to pick up to 3 targets (r c;r c;r c). Keep it
        // ugly/simple.
<span class="nc" id="L506">        adv.sendMessage(</span>
                &quot;PROMPT: Feud - select up to 3 opponent building coordinates as 'r c;r c;r c'. Opponent board:\n&quot;
<span class="nc" id="L508">                        + opp.printPrincipality());</span>
<span class="nc" id="L509">        String line = adv.receiveMessage();</span>
<span class="nc" id="L510">        java.util.List&lt;int[]&gt; picked = new java.util.ArrayList&lt;&gt;();</span>
        try {
<span class="nc bnc" id="L512" title="All 2 branches missed.">            for (String pair : line.split(&quot;;&quot;)) {</span>
<span class="nc" id="L513">                String s = pair.trim();</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">                if (s.isEmpty())</span>
<span class="nc" id="L515">                    continue;</span>
<span class="nc" id="L516">                String[] rc = s.split(&quot;\\s+&quot;);</span>
<span class="nc" id="L517">                int r = Integer.parseInt(rc[0]);</span>
<span class="nc" id="L518">                int c = Integer.parseInt(rc[1]);</span>
                // validate it's a building
<span class="nc" id="L520">                Card x = getSafe(opp, r, c);</span>
<span class="nc bnc" id="L521" title="All 6 branches missed.">                if (x != null &amp;&amp; x.type != null &amp;&amp; x.type.equalsIgnoreCase(&quot;Building&quot;)) {</span>
<span class="nc" id="L522">                    picked.add(new int[] { r, c });</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                    if (picked.size() == 3)</span>
<span class="nc" id="L524">                        break;</span>
                }
            }
<span class="nc" id="L527">        } catch (Exception ignored) {</span>
<span class="nc" id="L528">        }</span>

        // If invalid or too few, auto-fill from discovered buildings
<span class="nc" id="L531">        int k = 0;</span>
<span class="nc bnc" id="L532" title="All 4 branches missed.">        while (picked.size() &lt; 3 &amp;&amp; k &lt; buildings.size()) {</span>
<span class="nc" id="L533">            int[] bc = buildings.get(k++);</span>
            // avoid duplicates
<span class="nc" id="L535">            boolean dup = false;</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">            for (int[] pc : picked)</span>
<span class="nc bnc" id="L537" title="All 4 branches missed.">                if (pc[0] == bc[0] &amp;&amp; pc[1] == bc[1]) {</span>
<span class="nc" id="L538">                    dup = true;</span>
<span class="nc" id="L539">                    break;</span>
                }
<span class="nc bnc" id="L541" title="All 2 branches missed.">            if (!dup)</span>
<span class="nc" id="L542">                picked.add(bc);</span>
<span class="nc" id="L543">        }</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">        if (picked.isEmpty()) {</span>
<span class="nc" id="L545">            broadcast(&quot;Feud: no valid targets selected/found.&quot;);</span>
<span class="nc" id="L546">            return;</span>
        }

        // Opponent chooses which ONE to remove
<span class="nc" id="L550">        StringBuilder opts = new StringBuilder(&quot;PROMPT: Feud - choose which to remove (index 0..&quot;)</span>
<span class="nc" id="L551">                .append(picked.size() - 1)</span>
<span class="nc" id="L552">                .append(&quot;):\n&quot;);</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">        for (int i = 0; i &lt; picked.size(); i++) {</span>
<span class="nc" id="L554">            int r = picked.get(i)[0], c = picked.get(i)[1];</span>
<span class="nc" id="L555">            Card x = getSafe(opp, r, c);</span>
<span class="nc" id="L556">            opts.append(&quot;  [&quot;).append(i).append(&quot;] (&quot;).append(r).append(&quot;,&quot;).append(c).append(&quot;) &quot;).append(x)</span>
<span class="nc" id="L557">                    .append(&quot;\n&quot;);</span>
        }
<span class="nc" id="L559">        opp.sendMessage(opts.toString());</span>
<span class="nc" id="L560">        int choice = 0;</span>
        try {
<span class="nc" id="L562">            choice = Integer.parseInt(opp.receiveMessage().trim());</span>
<span class="nc" id="L563">        } catch (Exception ignored) {</span>
<span class="nc" id="L564">        }</span>
<span class="nc bnc" id="L565" title="All 4 branches missed.">        if (choice &lt; 0 || choice &gt;= picked.size())</span>
<span class="nc" id="L566">            choice = 0;</span>
<span class="nc" id="L567">        int rr = picked.get(choice)[0], cc = picked.get(choice)[1];</span>
<span class="nc" id="L568">        Card removed = opp.principality.get(rr).set(cc, null);</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">        broadcast(&quot;Feud: removed &quot; + (removed == null ? &quot;unknown&quot; : removed.name) + &quot; from opponent at (&quot; + rr + &quot;,&quot;</span>
                + cc + &quot;).&quot;);
<span class="nc" id="L571">        returnBuildingToBottom(removed);</span>
<span class="nc" id="L572">    }</span>

    private void resolveFraternalFeuds(Player active, Player other) {
<span class="nc bnc" id="L575" title="All 2 branches missed.">        Player adv = hasStrengthAdvantage(players.get(0), players.get(1)) ? players.get(0)</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                : hasStrengthAdvantage(players.get(1), players.get(0)) ? players.get(1)</span>
<span class="nc" id="L577">                        : null;</span>

<span class="nc bnc" id="L579" title="All 2 branches missed.">        if (adv == null) {</span>
<span class="nc" id="L580">            broadcast(&quot;Fraternal Feuds: no strength advantage; nothing happens.&quot;);</span>
<span class="nc" id="L581">            return;</span>
        }
<span class="nc bnc" id="L583" title="All 2 branches missed.">        Player opp = (adv == players.get(0)) ? players.get(1) : players.get(0);</span>

<span class="nc bnc" id="L585" title="All 2 branches missed.">        if (opp.hand.isEmpty()) {</span>
<span class="nc" id="L586">            broadcast(&quot;Fraternal Feuds: opponent hand empty.&quot;);</span>
<span class="nc" id="L587">            return;</span>
        }

<span class="nc" id="L590">        adv.sendMessage(&quot;PROMPT: Opponent hand:\n&quot; + opp.printHand() + &quot;Choose up to two indices (e.g., '2 5'):&quot;);</span>
<span class="nc" id="L591">        String sel = adv.receiveMessage();</span>
<span class="nc" id="L592">        java.util.Set&lt;Integer&gt; idxs = new java.util.HashSet&lt;&gt;();</span>
        try {
<span class="nc bnc" id="L594" title="All 2 branches missed.">            for (String tok : sel.trim().split(&quot;\\s+&quot;)) {</span>
<span class="nc" id="L595">                int i = Integer.parseInt(tok);</span>
<span class="nc bnc" id="L596" title="All 4 branches missed.">                if (i &gt;= 0 &amp;&amp; i &lt; opp.hand.size())</span>
<span class="nc" id="L597">                    idxs.add(i);</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                if (idxs.size() == 2)</span>
<span class="nc" id="L599">                    break;</span>
            }
<span class="nc" id="L601">        } catch (Exception ignored) {</span>
<span class="nc" id="L602">        }</span>

        // If insufficient/invalid, take first one or two
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (idxs.isEmpty()) {</span>
<span class="nc" id="L606">            idxs.add(0);</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">            if (opp.hand.size() &gt; 1)</span>
<span class="nc" id="L608">                idxs.add(1);</span>
        }

        // Remove in descending order so indices stay valid
<span class="nc" id="L612">        java.util.List&lt;Integer&gt; order = new java.util.ArrayList&lt;&gt;(idxs);</span>
<span class="nc" id="L613">        java.util.Collections.sort(order, java.util.Collections.reverseOrder());</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">        for (int i : order) {</span>
<span class="nc" id="L615">            Card rem = opp.hand.remove(i);</span>
<span class="nc" id="L616">            returnBuildingToBottom(rem);</span>
<span class="nc" id="L617">            broadcast(&quot;Fraternal Feuds: returned '&quot; + rem.name + &quot;' to bottom of a draw stack.&quot;);</span>
<span class="nc" id="L618">        }</span>

<span class="nc" id="L620">        markSkipReplenishOnce(opp);</span>
<span class="nc" id="L621">        broadcast(&quot;Fraternal Feuds: opponent cannot replenish hand at the end of the next turn.&quot;);</span>
<span class="nc" id="L622">    }</span>

    private void resolveTradeShipsRace() {
<span class="nc" id="L625">        int c0 = countTradeShips(players.get(0));</span>
<span class="nc" id="L626">        int c1 = countTradeShips(players.get(1));</span>

<span class="nc bnc" id="L628" title="All 4 branches missed.">        if (c0 == 0 &amp;&amp; c1 == 0) {</span>
<span class="nc" id="L629">            broadcast(&quot;Trade Ships Race: no one owns trade ships.&quot;);</span>
<span class="nc" id="L630">            return;</span>
        }
<span class="nc bnc" id="L632" title="All 2 branches missed.">        if (c0 &gt; c1) {</span>
<span class="nc" id="L633">            Player p = players.get(0);</span>
<span class="nc" id="L634">            p.sendMessage(</span>
                    &quot;PROMPT: Trade Ships Race - you have the most trade ships. Choose 1 resource [Brick|Grain|Lumber|Wool|Ore|Gold]:&quot;);
<span class="nc" id="L636">            p.gainResource(p.receiveMessage());</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">        } else if (c1 &gt; c0) {</span>
<span class="nc" id="L638">            Player p = players.get(1);</span>
<span class="nc" id="L639">            p.sendMessage(</span>
                    &quot;PROMPT: Trade Ships Race - you have the most trade ships. Choose 1 resource [Brick|Grain|Lumber|Wool|Ore|Gold]:&quot;);
<span class="nc" id="L641">            p.gainResource(p.receiveMessage());</span>
<span class="nc" id="L642">        } else { // tie</span>
<span class="nc bnc" id="L643" title="All 4 branches missed.">            if (c0 &gt;= 1 &amp;&amp; c1 &gt;= 1) {</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">                for (Player p : players) {</span>
<span class="nc" id="L645">                    p.sendMessage(</span>
                            &quot;PROMPT: Trade Ships Race (tie) - choose 1 resource [Brick|Grain|Lumber|Wool|Ore|Gold]:&quot;);
<span class="nc" id="L647">                    p.gainResource(p.receiveMessage());</span>
<span class="nc" id="L648">                }</span>
            } else {
<span class="nc" id="L650">                broadcast(&quot;Trade Ships Race: tie without both having ≥1 ship; no one receives a resource.&quot;);</span>
            }
        }
<span class="nc" id="L653">    }</span>

    private void resolveTravelingMerchant() {
<span class="nc bnc" id="L656" title="All 2 branches missed.">        for (Player p : players) {</span>
<span class="nc" id="L657">            int max = Math.min(2, p.getResourceCount(&quot;Gold&quot;));</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">            if (max &lt;= 0) {</span>
<span class="nc" id="L659">                p.sendMessage(&quot;Traveling Merchant: not enough Gold to trade (need 1 per resource).&quot;);</span>
<span class="nc" id="L660">                continue;</span>
            }
<span class="nc" id="L662">            p.sendMessage(</span>
                    &quot;PROMPT: Traveling Merchant - you may take up to &quot; + max + &quot; resources (1 Gold each). How many (0..&quot;
                            + max + &quot;)?&quot;);
<span class="nc" id="L665">            int k = 0;</span>
            try {
<span class="nc" id="L667">                k = Integer.parseInt(p.receiveMessage().trim());</span>
<span class="nc" id="L668">            } catch (Exception ignored) {</span>
<span class="nc" id="L669">            }</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">            if (k &lt; 0)</span>
<span class="nc" id="L671">                k = 0;</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">            if (k &gt; max)</span>
<span class="nc" id="L673">                k = max;</span>

<span class="nc bnc" id="L675" title="All 2 branches missed.">            for (int i = 0; i &lt; k; i++) {</span>
<span class="nc" id="L676">                p.sendMessage(&quot;PROMPT: Pick resource #&quot; + (i + 1) + &quot;:&quot;);</span>
<span class="nc" id="L677">                String res = p.receiveMessage();</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">                if (p.removeResource(&quot;Gold&quot;, 1)) {</span>
<span class="nc" id="L679">                    p.gainResource(res);</span>
                } else {
<span class="nc" id="L681">                    p.sendMessage(&quot;No more Gold; stopping.&quot;);</span>
<span class="nc" id="L682">                    break;</span>
                }
            }
<span class="nc" id="L685">        }</span>
<span class="nc" id="L686">    }</span>

    private void resolveYearOfPlenty() {
<span class="nc bnc" id="L689" title="All 2 branches missed.">        for (Player p : players) {</span>
<span class="nc" id="L690">            int added = 0;</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">            for (int r = 0; r &lt; p.principality.size(); r++) {</span>
<span class="nc" id="L692">                var row = p.principality.get(r);</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">                for (int c = 0; c &lt; row.size(); c++) {</span>
<span class="nc" id="L694">                    Card reg = row.get(c);</span>
<span class="nc bnc" id="L695" title="All 4 branches missed.">                    if (reg == null || !&quot;Region&quot;.equalsIgnoreCase(reg.type))</span>
<span class="nc" id="L696">                        continue;</span>

<span class="nc" id="L698">                    int adj = countAdjStorehouseAbbey(p, r, c);</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">                    while (adj-- &gt; 0) {</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">                        if (reg.regionProduction &lt; 3) {</span>
<span class="nc" id="L701">                            reg.regionProduction++;</span>
<span class="nc" id="L702">                            added++;</span>
                        }
                    }
                }
            }
<span class="nc" id="L707">            p.sendMessage(&quot;Year of Plenty: resources were added to your regions where adjacent to Storehouse/Abbey.&quot;);</span>
<span class="nc" id="L708">        }</span>
<span class="nc" id="L709">    }</span>

    private void resolveInvention() {
<span class="nc bnc" id="L712" title="All 2 branches missed.">        for (Player p : players) {</span>
<span class="nc" id="L713">            int times = Math.min(2, Math.max(0, p.progressPoints));</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">            if (times == 0) {</span>
<span class="nc" id="L715">                p.sendMessage(&quot;Invention: you have no progress point buildings (max 2).&quot;);</span>
<span class="nc" id="L716">                continue;</span>
            }
<span class="nc bnc" id="L718" title="All 2 branches missed.">            for (int i = 0; i &lt; times; i++) {</span>
<span class="nc" id="L719">                p.sendMessage(&quot;PROMPT: Invention - gain resource #&quot; + (i + 1) + &quot; of your choice:&quot;);</span>
<span class="nc" id="L720">                String res = p.receiveMessage();</span>
<span class="nc" id="L721">                p.gainResource(res);</span>
            }
<span class="nc" id="L723">        }</span>
<span class="nc" id="L724">    }</span>

    private void returnBuildingToBottom(Card bld) {
<span class="nc bnc" id="L727" title="All 2 branches missed.">        if (bld == null)</span>
<span class="nc" id="L728">            return;</span>
        // Super quick: push to bottom of drawStack1
<span class="nc" id="L730">        Card.drawStack1.add(bld);</span>
<span class="nc" id="L731">    }</span>

    private void markSkipReplenishOnce(Player p) {
<span class="nc bnc" id="L734" title="All 2 branches missed.">        if (p.flags == null)</span>
<span class="nc" id="L735">            p.flags = new java.util.HashSet&lt;&gt;();</span>
<span class="nc" id="L736">        p.flags.add(&quot;NO_REPLENISH_ONCE&quot;);</span>
<span class="nc" id="L737">    }</span>

    private boolean hasStrengthAdvantage(Player a, Player b) {
        // Simple: &gt;=3 Strength and strictly more than opponent
<span class="nc bnc" id="L741" title="All 4 branches missed.">        return a.strengthPoints &gt;= 3 &amp;&amp; a.strengthPoints &gt; b.strengthPoints;</span>
    }

    private int countTradeShips(Player p) {
<span class="nc" id="L745">        int count = 0;</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">        for (int r = 0; r &lt; p.principality.size(); r++) {</span>
<span class="nc" id="L747">            var row = p.principality.get(r);</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">            for (int c = 0; c &lt; row.size(); c++) {</span>
<span class="nc" id="L749">                Card x = row.get(c);</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">                if (x == null)</span>
<span class="nc" id="L751">                    continue;</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                String t = x.type == null ? &quot;&quot; : x.type;</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">                String pl = x.placement == null ? &quot;&quot; : x.placement;</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">                if (t.toLowerCase().contains(&quot;trade ship&quot;) ||</span>
<span class="nc bnc" id="L755" title="All 4 branches missed.">                        (pl.toLowerCase().contains(&quot;settlement/city&quot;) &amp;&amp; x.name != null</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">                                &amp;&amp; x.name.toLowerCase().endsWith(&quot;ship&quot;))) {</span>
<span class="nc" id="L757">                    count++;</span>
                }
            }
        }
<span class="nc" id="L761">        return count;</span>
    }

    // Helpers for Brigand / Toll Bridge
    private int countGoldAndWool(Player p, boolean excludeStorehouseAdj) {
<span class="fc" id="L766">        int total = 0;</span>
<span class="pc bpc" id="L767" title="1 of 2 branches missed.">        Set&lt;String&gt; excluded = excludeStorehouseAdj ? storehouseExcludedKeys(p) : Set.of();</span>
<span class="fc bfc" id="L768" title="All 2 branches covered.">        for (int r = 0; r &lt; p.principality.size(); r++) {</span>
<span class="fc" id="L769">            java.util.List&lt;Card&gt; row = p.principality.get(r);</span>
<span class="pc bpc" id="L770" title="1 of 2 branches missed.">            if (row == null)</span>
<span class="nc" id="L771">                continue;</span>
<span class="fc bfc" id="L772" title="All 2 branches covered.">            for (int c = 0; c &lt; row.size(); c++) {</span>
<span class="fc" id="L773">                Card card = row.get(c);</span>
<span class="fc bfc" id="L774" title="All 2 branches covered.">                if (card == null)</span>
<span class="fc" id="L775">                    continue;</span>
<span class="fc" id="L776">                String key = r + &quot;:&quot; + c;</span>
<span class="pc bpc" id="L777" title="1 of 2 branches missed.">                if (excluded.contains(key))</span>
<span class="nc" id="L778">                    continue;</span>
<span class="fc bfc" id="L779" title="All 4 branches covered.">                if (&quot;Gold Field&quot;.equalsIgnoreCase(card.name) || &quot;Pasture&quot;.equalsIgnoreCase(card.name)) {</span>
<span class="fc" id="L780">                    total += Math.max(0, Math.min(3, card.regionProduction));</span>
                }
            }
        }

<span class="fc" id="L785">        return total;</span>
    }

    private void zeroGoldAndWool(Player p, boolean excludeStorehouseAdj) {
<span class="pc bpc" id="L789" title="1 of 2 branches missed.">        Set&lt;String&gt; excluded = excludeStorehouseAdj ? storehouseExcludedKeys(p) : Set.of();</span>
<span class="fc" id="L790">        forEachRegion(p, (r, c, card) -&gt; {</span>
<span class="pc bpc" id="L791" title="1 of 2 branches missed.">            if (card == null)</span>
<span class="nc" id="L792">                return;</span>
<span class="fc" id="L793">            String key = r + &quot;:&quot; + c;</span>
<span class="pc bpc" id="L794" title="1 of 2 branches missed.">            if (excluded.contains(key))</span>
<span class="nc" id="L795">                return;</span>
<span class="fc bfc" id="L796" title="All 4 branches covered.">            if (&quot;Gold Field&quot;.equalsIgnoreCase(card.name) || &quot;Pasture&quot;.equalsIgnoreCase(card.name)) {</span>
<span class="fc" id="L797">                card.regionProduction = 0;</span>
            }
<span class="fc" id="L799">        });</span>
<span class="fc" id="L800">    }</span>

    private int grantGoldIfSpace(Player p, int want) {
<span class="nc" id="L803">        int given = 0;</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">        for (int r = 0; r &lt; p.principality.size(); r++) {</span>
<span class="nc" id="L805">            java.util.List&lt;Card&gt; row = p.principality.get(r);</span>
<span class="nc bnc" id="L806" title="All 2 branches missed.">            if (row == null)</span>
<span class="nc" id="L807">                continue;</span>
<span class="nc bnc" id="L808" title="All 2 branches missed.">            for (int c = 0; c &lt; row.size(); c++) {</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">                if (given &gt;= want)</span>
<span class="nc" id="L810">                    break; // stop if already satisfied</span>
<span class="nc" id="L811">                Card card = row.get(c);</span>
<span class="nc bnc" id="L812" title="All 4 branches missed.">                if (card != null &amp;&amp; &quot;Gold Field&quot;.equalsIgnoreCase(card.name)) {</span>
<span class="nc" id="L813">                    int can = Math.max(0, 3 - card.regionProduction);</span>
<span class="nc" id="L814">                    int add = Math.min(can, want - given);</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">                    if (add &gt; 0) {</span>
<span class="nc" id="L816">                        card.regionProduction += add;</span>
<span class="nc" id="L817">                        given += add;</span>
                    }
                }
            }
        }
<span class="nc" id="L822">        return given;</span>
    }

    // Storehouse excludes regions immediately left/right of each Storehouse (same
    // side of center)
    private Set&lt;String&gt; storehouseExcludedKeys(Player p) {
<span class="fc" id="L828">        Set&lt;String&gt; out = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L829" title="All 2 branches covered.">        for (int r = 0; r &lt; p.principality.size(); r++) {</span>
<span class="fc" id="L830">            List&lt;Card&gt; row = p.principality.get(r);</span>
<span class="fc bfc" id="L831" title="All 2 branches covered.">            for (int c = 0; c &lt; row.size(); c++) {</span>
<span class="fc" id="L832">                Card x = row.get(c);</span>
<span class="pc bpc" id="L833" title="2 of 6 branches missed.">                if (x != null &amp;&amp; x.name != null &amp;&amp; x.name.equalsIgnoreCase(&quot;Storehouse&quot;)) {</span>
                    // Decide side: if there’s a settlement/city below we’re on upper side, else
                    // lower
<span class="nc bnc" id="L836" title="All 2 branches missed.">                    boolean belowCenter = nmAt(p.getCard(r + 1, c), &quot;Settlement&quot;, &quot;City&quot;)</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">                            || nmAt(p.getCard(r + 2, c), &quot;City&quot;, &quot;City&quot;);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">                    int regionRow = belowCenter ? r - 1 : r + 1;</span>
<span class="nc" id="L839">                    out.add(regionRow + &quot;:&quot; + (c - 1));</span>
<span class="nc" id="L840">                    out.add(regionRow + &quot;:&quot; + (c + 1));</span>
                }
            }
        }
<span class="fc" id="L844">        return out;</span>
    }

    private static boolean nmAt(Card c, String a, String b) {
<span class="nc bnc" id="L848" title="All 4 branches missed.">        if (c == null || c.name == null)</span>
<span class="nc" id="L849">            return false;</span>
<span class="nc bnc" id="L850" title="All 4 branches missed.">        return c.name.equalsIgnoreCase(a) || c.name.equalsIgnoreCase(b);</span>
    }

    private interface RegionVisitor {
        void visit(int r, int c, Card card);
    }

    private void forEachRegion(Player p, RegionVisitor v) {
<span class="fc bfc" id="L858" title="All 2 branches covered.">        for (int r = 0; r &lt; p.principality.size(); r++) {</span>
<span class="fc" id="L859">            List&lt;Card&gt; row = p.principality.get(r);</span>
<span class="fc bfc" id="L860" title="All 2 branches covered.">            for (int c = 0; c &lt; row.size(); c++) {</span>
<span class="fc" id="L861">                Card card = row.get(c);</span>
<span class="fc bfc" id="L862" title="All 4 branches covered.">                if (card != null &amp;&amp; &quot;Region&quot;.equalsIgnoreCase(card.type))</span>
<span class="fc" id="L863">                    v.visit(r, c, card);</span>
            }
        }
<span class="fc" id="L866">    }</span>

    private Player opponentOf(Player p) {
<span class="nc bnc" id="L869" title="All 2 branches missed.">        return (p == players.get(0)) ? players.get(1) : players.get(0);</span>
    }

    // ---------- Actions ----------
    private void actionPhase(Player active, Player other) {
<span class="nc" id="L874">        boolean done = false;</span>
<span class="nc" id="L875">        active.sendMessage(&quot;Opponent's board:&quot;);</span>
<span class="nc" id="L876">        active.sendMessage(&quot;\t\t&quot; + other.printPrincipality().replace(&quot;\n&quot;, &quot;\n\t\t&quot;));</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">        while (!done) {</span>
<span class="nc" id="L878">            active.sendMessage(&quot;Your board:&quot;);</span>
<span class="nc" id="L879">            active.sendMessage(active.printPrincipality());</span>
<span class="nc" id="L880">            active.sendMessage(&quot;Your hand:&quot;);</span>
<span class="nc" id="L881">            active.sendMessage(active.printHand());</span>
<span class="nc" id="L882">            active.sendMessage(&quot;Action Phase:&quot;);</span>
<span class="nc" id="L883">            active.sendMessage(&quot;  TRADE3 &lt;get&gt; &lt;give&gt;     — bank 3:1 ([Brick|Grain|Lumber|Wool|Ore|Gold])&quot;);</span>
<span class="nc" id="L884">            active.sendMessage(</span>
                    &quot;  TRADE2 &lt;get&gt; &lt;Res&gt;      — if you have a 2:1 ship for &lt;Res&gt; ([Brick|Grain|Lumber|Wool|Ore|Gold])&quot;);
<span class="nc" id="L886">            active.sendMessage(</span>
                    &quot;  LTS &lt;L|R&gt; &lt;2from&gt; &lt;1to&gt; — Large Trade Ship adjacent trade (left/right side) ([Brick|Grain|Lumber|Wool|Ore|Gold])&quot;);
            // Allow PLAY to play cards from hand or center cards
<span class="nc" id="L889">            String play = &quot;  PLAY &lt;cardName&gt; | &lt;id&gt;  — play a card from hand / play center card: &quot;;</span>

            // Add Center card options that are actually available
<span class="nc" id="L892">            ArrayList&lt;String&gt; buildBits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">            if (!Card.roads.isEmpty()) {</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">                String cost = Card.roads.get(0).cost == null ? &quot;-&quot; : Card.roads.get(0).cost;</span>
<span class="nc" id="L895">                buildBits.add(&quot;ROAD(&quot; + cost + &quot;)&quot;);</span>
            }
<span class="nc bnc" id="L897" title="All 2 branches missed.">            if (!Card.settlements.isEmpty()) {</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">                String cost = Card.settlements.get(0).cost == null ? &quot;-&quot; : Card.settlements.get(0).cost;</span>
<span class="nc" id="L899">                buildBits.add(&quot;SETTLEMENT(&quot; + cost + &quot;)&quot;);</span>
            }
<span class="nc bnc" id="L901" title="All 2 branches missed.">            if (!Card.cities.isEmpty()) {</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">                String cost = Card.cities.get(0).cost == null ? &quot;-&quot; : Card.cities.get(0).cost;</span>
<span class="nc" id="L903">                buildBits.add(&quot;CITY(&quot; + cost + &quot;)&quot;);</span>
            }
<span class="nc" id="L905">            play += String.join(&quot;, &quot;, buildBits);</span>
<span class="nc" id="L906">            active.sendMessage(play);</span>
<span class="nc" id="L907">            active.sendMessage(&quot;  END                     — finish action phase&quot;);</span>
<span class="nc" id="L908">            active.sendMessage(&quot;PROMPT: make your choice: &quot;);</span>
<span class="nc" id="L909">            String cmd = active.receiveMessage();</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">            if (cmd == null)</span>
<span class="nc" id="L911">                cmd = &quot;END&quot;;</span>
<span class="nc" id="L912">            String up = cmd.trim().toUpperCase(Locale.ROOT);</span>

<span class="nc bnc" id="L914" title="All 2 branches missed.">            if (up.startsWith(&quot;TRADE3&quot;)) {</span>
<span class="nc" id="L915">                String[] parts = cmd.trim().split(&quot;\\s+&quot;);</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">                if (parts.length &gt;= 3) {</span>
<span class="nc" id="L917">                    String get = parts[1];</span>
<span class="nc" id="L918">                    String give = parts[2];</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">                    if (active.getResourceCount(give) &gt;= 3) {</span>
<span class="nc" id="L920">                        active.removeResource(give, 3);</span>
<span class="nc" id="L921">                        active.gainResource(get);</span>
<span class="nc" id="L922">                        broadcast(&quot;Trade 3:1 -&gt; +1 &quot; + get);</span>
                    } else
<span class="nc" id="L924">                        active.sendMessage(&quot;Not enough &quot; + give + &quot; to trade 3:1.&quot;);</span>
<span class="nc" id="L925">                } else</span>
<span class="nc" id="L926">                    active.sendMessage(&quot;Usage: TRADE3 &lt;get&gt; &lt;give&gt; ([Brick|Grain|Lumber|Wool|Ore|Gold])&quot;);</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">            } else if (up.startsWith(&quot;TRADE2&quot;)) {</span>
                // Requires a flag 2FOR1_&lt;RES&gt;
<span class="nc" id="L929">                String[] parts = cmd.trim().split(&quot;\\s+&quot;);</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">                if (parts.length &gt;= 3) {</span>
<span class="nc" id="L931">                    String get = parts[1];</span>
<span class="nc" id="L932">                    String from = parts[2].toUpperCase();</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">                    if (active.flags.contains(&quot;2FOR1_&quot; + from)) {</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">                        if (active.getResourceCount(from) &gt;= 2) {</span>
<span class="nc" id="L935">                            active.removeResource(from, 2);</span>
<span class="nc" id="L936">                            active.gainResource(get);</span>
<span class="nc" id="L937">                            broadcast(&quot;Trade 2:1 (&quot; + from + &quot; ship) -&gt; +1 &quot; + get);</span>
                        } else
<span class="nc" id="L939">                            active.sendMessage(&quot;Not enough &quot; + from + &quot; to trade 2:1.&quot;);</span>
                    } else
<span class="nc" id="L941">                        active.sendMessage(&quot;You don't have a 2:1 ship for &quot; + from + &quot;.&quot;);</span>
<span class="nc" id="L942">                } else</span>
<span class="nc" id="L943">                    active.sendMessage(&quot;Usage: TRADE2 &lt;get&gt; &lt;give&gt; ([Brick|Grain|Lumber|Wool|Ore|Gold])&quot;);</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">            } else if (up.startsWith(&quot;LTS&quot;)) {</span>
                // LTS &lt;L|R&gt; &lt;two-from&gt; &lt;one-to&gt;
<span class="nc" id="L946">                String[] parts = cmd.trim().split(&quot;\\s+&quot;);</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">                if (parts.length &gt;= 4) {</span>
<span class="nc" id="L948">                    String side = parts[1].toUpperCase(); // L or R</span>
<span class="nc" id="L949">                    String twoFrom = parts[2];</span>
<span class="nc" id="L950">                    String oneTo = parts[3];</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">                    if (applyLTS(active, side, twoFrom, oneTo))</span>
<span class="nc" id="L952">                        broadcast(&quot;LTS: traded 2 &quot; + twoFrom + &quot; for 1 &quot; + oneTo + &quot; on the &quot;</span>
<span class="nc bnc" id="L953" title="All 2 branches missed.">                                + (side.startsWith(&quot;L&quot;) ? &quot;LEFT&quot; : &quot;RIGHT&quot;));</span>
                    else
<span class="nc" id="L955">                        active.sendMessage(&quot;LTS trade invalid here.&quot;);</span>
<span class="nc" id="L956">                } else</span>
<span class="nc" id="L957">                    active.sendMessage(&quot;Usage: LTS &lt;L|R&gt; &lt;2from&gt; &lt;1to&gt; ([Brick|Grain|Lumber|Wool|Ore|Gold])&quot;);</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">            } else if (up.startsWith(&quot;PLAY&quot;)) {</span>
                // PLAY &lt;cardName&gt;|&lt;id&gt;
<span class="nc" id="L960">                String[] parts = cmd.trim().split(&quot;\\s+&quot;, 2);</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">                if (parts.length &lt; 2) {</span>
<span class="nc" id="L962">                    active.sendMessage(&quot;Usage: PLAY &lt;cardName&gt; | &lt;id&gt;&quot;);</span>
<span class="nc" id="L963">                    continue;</span>
                }
<span class="nc" id="L965">                String spec = parts[1].trim();</span>

                // ---------- 1) Center cards from piles: Road / Settlement / City ----------
<span class="nc bnc" id="L968" title="All 4 branches missed.">                if (spec.equalsIgnoreCase(&quot;Road&quot;) || spec.equalsIgnoreCase(&quot;Settlement&quot;)</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">                        || spec.equalsIgnoreCase(&quot;City&quot;)) {</span>
<span class="nc" id="L970">                    Vector&lt;Card&gt; pile = null;</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">                    if (spec.equalsIgnoreCase(&quot;Road&quot;))</span>
<span class="nc" id="L972">                        pile = Card.roads;</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">                    else if (spec.equalsIgnoreCase(&quot;Settlement&quot;))</span>
<span class="nc" id="L974">                        pile = Card.settlements;</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">                    else if (spec.equalsIgnoreCase(&quot;City&quot;))</span>
<span class="nc" id="L976">                        pile = Card.cities;</span>

<span class="nc bnc" id="L978" title="All 4 branches missed.">                    if (pile == null || pile.isEmpty()) {</span>
<span class="nc" id="L979">                        active.sendMessage(&quot;No &quot; + spec + &quot; cards left in the pile.&quot;);</span>
<span class="nc" id="L980">                        continue;</span>
                    }

                    // Peek (do not remove yet)
<span class="nc" id="L984">                    Card proto = pile.firstElement();</span>

                    // Check &amp; pay cost first (do NOT mutate piles yet)
<span class="nc bnc" id="L987" title="All 2 branches missed.">                    if (!payCost(active, proto.cost)) {</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">                        active.sendMessage(&quot;Can't afford cost: &quot; + (proto.cost == null ? &quot;-&quot; : proto.cost));</span>
<span class="nc" id="L989">                        continue;</span>
                    }

                    // Ask coordinates and attempt placement
<span class="nc" id="L993">                    active.sendMessage(&quot;PROMPT: Enter placement coordinates as: ROW COL&quot;);</span>
<span class="nc" id="L994">                    int row = -1, col = -1;</span>
                    try {
<span class="nc" id="L996">                        String[] rc = active.receiveMessage().trim().split(&quot;\\s+&quot;);</span>
<span class="nc" id="L997">                        row = Integer.parseInt(rc[0]);</span>
<span class="nc" id="L998">                        col = Integer.parseInt(rc[1]);</span>
<span class="nc" id="L999">                    } catch (Exception e) {</span>
<span class="nc" id="L1000">                        active.sendMessage(&quot;Invalid coordinates. Use: ROW COL (e.g., 2 3)&quot;);</span>
<span class="nc" id="L1001">                        refundCost(active, proto.cost);</span>
<span class="nc" id="L1002">                        continue;</span>
<span class="nc" id="L1003">                    }</span>

<span class="nc" id="L1005">                    boolean ok = proto.applyEffect(active, other, row, col);</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">                    if (!ok) {</span>
<span class="nc" id="L1007">                        active.sendMessage(&quot;Illegal placement/effect; refunding cost.&quot;);</span>
<span class="nc" id="L1008">                        refundCost(active, proto.cost);</span>
<span class="nc" id="L1009">                        continue;</span>
                    }

                    // Success → remove from pile now
<span class="nc" id="L1013">                    pile.remove(0);</span>
<span class="nc" id="L1014">                    broadcast(&quot;Built &quot; + spec + &quot; at (&quot; + row + &quot;,&quot; + col + &quot;)&quot;);</span>
<span class="nc" id="L1015">                    continue;</span>
                }

                // ---------- 2) Cards from the player's HAND ----------
                // Resolve by index or name
<span class="nc" id="L1020">                Card c = findCardInHand(active, spec);</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">                if (c == null) {</span>
<span class="nc" id="L1022">                    active.sendMessage(&quot;No such card in hand: &quot; + spec);</span>
<span class="nc" id="L1023">                    continue;</span>
                }

                // Check &amp; pay cost (only now)
<span class="nc bnc" id="L1027" title="All 2 branches missed.">                if (!payCost(active, c.cost)) {</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">                    active.sendMessage(&quot;Can't afford cost: &quot; + (c.cost == null ? &quot;-&quot; : c.cost));</span>
<span class="nc" id="L1029">                    continue;</span>
                }

<span class="nc bnc" id="L1032" title="All 4 branches missed.">                boolean isAction = (c.type != null &amp;&amp; c.type.toLowerCase().contains(&quot;action&quot;));</span>
                boolean ok;

<span class="nc bnc" id="L1035" title="All 2 branches missed.">                if (isAction) {</span>
                    // Action cards: no placement
<span class="nc" id="L1037">                    ok = c.applyEffect(active, other, -1, -1);</span>
<span class="nc bnc" id="L1038" title="All 2 branches missed.">                    if (!ok) {</span>
<span class="nc" id="L1039">                        active.sendMessage(&quot;Action could not be resolved; refunding cost.&quot;);</span>
<span class="nc" id="L1040">                        refundCost(active, c.cost);</span>
<span class="nc" id="L1041">                        continue;</span>
                    }
                    // Success → remove the specific instance from hand
<span class="nc" id="L1044">                    active.hand.remove(c);</span>
<span class="nc" id="L1045">                    broadcast(&quot;Current player played action &quot; + c.name);</span>
                } else {
                    // Non-action: needs placement
<span class="nc" id="L1048">                    active.sendMessage(&quot;PROMPT: Enter placement coordinates as: ROW COL&quot;);</span>
<span class="nc" id="L1049">                    int row = -1, col = -1;</span>
                    try {
<span class="nc" id="L1051">                        String[] rc = active.receiveMessage().trim().split(&quot;\\s+&quot;);</span>
<span class="nc" id="L1052">                        row = Integer.parseInt(rc[0]);</span>
<span class="nc" id="L1053">                        col = Integer.parseInt(rc[1]);</span>
<span class="nc" id="L1054">                    } catch (Exception e) {</span>
<span class="nc" id="L1055">                        active.sendMessage(&quot;Invalid coordinates. Use: ROW COL (e.g., 2 3)&quot;);</span>
<span class="nc" id="L1056">                        refundCost(active, c.cost);</span>
<span class="nc" id="L1057">                        continue;</span>
<span class="nc" id="L1058">                    }</span>

<span class="nc" id="L1060">                    ok = c.applyEffect(active, other, row, col);</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">                    if (!ok) {</span>
<span class="nc" id="L1062">                        active.sendMessage(&quot;Illegal placement/effect; refunding cost.&quot;);</span>
<span class="nc" id="L1063">                        refundCost(active, c.cost);</span>
<span class="nc" id="L1064">                        continue;</span>
                    }

                    // Success → remove the specific instance from hand
<span class="nc" id="L1068">                    active.hand.remove(c);</span>
<span class="nc" id="L1069">                    broadcast(&quot;Current player played &quot; + c.name + &quot; at (&quot; + row + &quot;,&quot; + col + &quot;)&quot;);</span>
                }
<span class="nc bnc" id="L1071" title="All 2 branches missed.">            } else if (up.startsWith(&quot;END&quot;)) {</span>
<span class="nc" id="L1072">                done = true;</span>
            } else {
<span class="nc" id="L1074">                active.sendMessage(&quot;Unknown command.&quot;);</span>
            }
<span class="nc" id="L1076">        }</span>
<span class="nc" id="L1077">    }</span>

    private Card findCardInHand(Player p, String spec) {
<span class="nc bnc" id="L1080" title="All 2 branches missed.">        if (spec == null)</span>
<span class="nc" id="L1081">            return null;</span>
<span class="nc" id="L1082">        spec = spec.trim();</span>

        // Numeric index?
        try {
<span class="nc" id="L1086">            int idx = Integer.parseInt(spec);</span>
<span class="nc bnc" id="L1087" title="All 4 branches missed.">            if (idx &gt;= 0 &amp;&amp; idx &lt; p.hand.size())</span>
<span class="nc" id="L1088">                return p.hand.get(idx);</span>
<span class="nc" id="L1089">        } catch (NumberFormatException ignored) {</span>
<span class="nc" id="L1090">        }</span>

        // Exact name match
<span class="nc bnc" id="L1093" title="All 2 branches missed.">        for (Card c : p.hand) {</span>
<span class="nc bnc" id="L1094" title="All 6 branches missed.">            if (c != null &amp;&amp; c.name != null &amp;&amp; c.name.equalsIgnoreCase(spec))</span>
<span class="nc" id="L1095">                return c;</span>
<span class="nc" id="L1096">        }</span>
        // Prefix fallback
<span class="nc" id="L1098">        String lower = spec.toLowerCase();</span>
<span class="nc bnc" id="L1099" title="All 2 branches missed.">        for (Card c : p.hand) {</span>
<span class="nc bnc" id="L1100" title="All 6 branches missed.">            if (c != null &amp;&amp; c.name != null &amp;&amp; c.name.toLowerCase().startsWith(lower))</span>
<span class="nc" id="L1101">                return c;</span>
<span class="nc" id="L1102">        }</span>
<span class="nc" id="L1103">        return null;</span>
    }

    private boolean payCost(Player p, String cost) {
<span class="nc bnc" id="L1107" title="All 4 branches missed.">        if (cost == null || cost.isBlank())</span>
<span class="nc" id="L1108">            return true;</span>
        // Cost like &quot;1 Brick, 1 Grain, 1 Wool, 1 Lumber&quot; etc.
<span class="nc" id="L1110">        Map&lt;String, Integer&gt; need = parseCost(cost);</span>
<span class="nc bnc" id="L1111" title="All 2 branches missed.">        for (var e : need.entrySet()) {</span>
<span class="nc bnc" id="L1112" title="All 2 branches missed.">            if (p.getResourceCount(e.getKey()) &lt; e.getValue())</span>
<span class="nc" id="L1113">                return false;</span>
<span class="nc" id="L1114">        }</span>
<span class="nc bnc" id="L1115" title="All 2 branches missed.">        for (var e : need.entrySet()) {</span>
<span class="nc" id="L1116">            p.removeResource(e.getKey(), e.getValue());</span>
<span class="nc" id="L1117">        }</span>
<span class="nc" id="L1118">        return true;</span>
    }

    private void refundCost(Player p, String cost) {
<span class="nc bnc" id="L1122" title="All 4 branches missed.">        if (cost == null || cost.isBlank())</span>
<span class="nc" id="L1123">            return;</span>
<span class="nc" id="L1124">        Map&lt;String, Integer&gt; need = parseCost(cost);</span>
<span class="nc bnc" id="L1125" title="All 2 branches missed.">        for (var e : need.entrySet())</span>
<span class="nc" id="L1126">            p.setResourceCount(e.getKey(), p.getResourceCount(e.getKey()) + e.getValue());</span>
<span class="nc" id="L1127">    }</span>

    // Maps single-letter cost codes to canonical resource names used everywhere
    // else.
    // B=Brick, G=Grain, L=Lumber, W=Wool, O=Ore, A=Gold
    private String letterToResource(char ch) {
<span class="nc bnc" id="L1133" title="All 7 branches missed.">        switch (Character.toUpperCase(ch)) {</span>
            case 'B':
<span class="nc" id="L1135">                return &quot;Brick&quot;;</span>
            case 'G':
<span class="nc" id="L1137">                return &quot;Grain&quot;;</span>
            case 'L':
<span class="nc" id="L1139">                return &quot;Lumber&quot;;</span>
            case 'W':
<span class="nc" id="L1141">                return &quot;Wool&quot;;</span>
            case 'O':
<span class="nc" id="L1143">                return &quot;Ore&quot;;</span>
            case 'A':
<span class="nc" id="L1145">                return &quot;Gold&quot;;</span>
            default:
<span class="nc" id="L1147">                return null; // unknown / ignore</span>
        }
    }

    private Map&lt;String, Integer&gt; parseCost(String cost) {
<span class="nc" id="L1152">        Map&lt;String, Integer&gt; m = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">        if (cost == null)</span>
<span class="nc" id="L1154">            return m;</span>

        // Accept strings like &quot;LW&quot;, &quot;AA&quot;, with optional spaces or separators (&quot;L,W&quot;, &quot;A
        // A&quot;)
<span class="nc bnc" id="L1158" title="All 2 branches missed.">        for (int i = 0; i &lt; cost.length(); i++) {</span>
<span class="nc" id="L1159">            char ch = cost.charAt(i);</span>
<span class="nc bnc" id="L1160" title="All 8 branches missed.">            if (Character.isWhitespace(ch) || ch == ',' || ch == ';' || ch == '+')</span>
<span class="nc" id="L1161">                continue;</span>
<span class="nc" id="L1162">            String res = letterToResource(ch);</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">            if (res != null) {</span>
<span class="nc" id="L1164">                m.put(res, m.getOrDefault(res, 0) + 1);</span>
            }
            // else: silently ignore unknown chars
        }
<span class="nc" id="L1168">        return m;</span>
    }

    // Large Trade Ship trade: side L/R relative to a placed LTS@row,col
    private boolean applyLTS(Player p, String side, String twoFrom, String oneTo) {
        // Find any LTS flag; for simplicity use the first one
<span class="nc" id="L1174">        int ltsRow = -1, ltsCol = -1;</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">        for (String f : p.flags) {</span>
<span class="nc bnc" id="L1176" title="All 2 branches missed.">            if (f.startsWith(&quot;LTS@&quot;)) {</span>
<span class="nc" id="L1177">                String[] rc = f.substring(4).split(&quot;,&quot;);</span>
                try {
<span class="nc" id="L1179">                    ltsRow = Integer.parseInt(rc[0]);</span>
<span class="nc" id="L1180">                    ltsCol = Integer.parseInt(rc[1]);</span>
<span class="nc" id="L1181">                } catch (Exception ignored) {</span>
<span class="nc" id="L1182">                }</span>
<span class="nc" id="L1183">                break;</span>
            }
<span class="nc" id="L1185">        }</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">        if (ltsRow &lt; 0)</span>
<span class="nc" id="L1187">            return false;</span>

        // Regions on that side are at (ltsRow, ltsCol-1) and (ltsRow, ltsCol+1)
<span class="nc bnc" id="L1190" title="All 2 branches missed.">        int takeCol = side.startsWith(&quot;L&quot;) ? ltsCol - 1 : ltsCol + 1;</span>
<span class="nc" id="L1191">        Card fromRegion = getSafe(p, ltsRow, takeCol);</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">        Card toRegion = getSafe(p, ltsRow, (side.startsWith(&quot;L&quot;) ? ltsCol + 1 : ltsCol - 1));</span>

<span class="nc bnc" id="L1194" title="All 4 branches missed.">        if (fromRegion == null || toRegion == null)</span>
<span class="nc" id="L1195">            return false;</span>

        // We don’t track per-resource piles, but we *do* track regionProduction; allow
        // trade if fromRegion’s
        // produced resource type matches `twoFrom` and has at least 2; grant +1 to
        // `oneTo` by increasing toRegion
<span class="nc" id="L1201">        String fromType = REGION_TO_RESOURCE.getOrDefault(fromRegion.name, &quot;&quot;);</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">        if (!fromType.equalsIgnoreCase(twoFrom))</span>
<span class="nc" id="L1203">            return false;</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">        if (fromRegion.regionProduction &lt; 2)</span>
<span class="nc" id="L1205">            return false;</span>

<span class="nc" id="L1207">        fromRegion.regionProduction -= 2;</span>
        // Grant the “oneTo”: if it matches toRegion’s type, store there; else bank
<span class="nc" id="L1209">        String toType = REGION_TO_RESOURCE.getOrDefault(toRegion.name, &quot;&quot;);</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">        if (toType.equalsIgnoreCase(oneTo)) {</span>
<span class="nc" id="L1211">            toRegion.regionProduction = Math.min(3, toRegion.regionProduction + 1);</span>
        } else {
<span class="nc" id="L1213">            p.gainResource(oneTo);</span>
        }
<span class="nc" id="L1215">        return true;</span>
    }

    private Card getSafe(Player p, int r, int c) {
<span class="nc" id="L1219">        return p.getCard(r, c);</span>
    }

    // Very simple adjacency for YOP: count Storehouse/Abbey directly above/below
    // same column
    private int countAdjStorehouseAbbey(Player p, int rr, int cc) {
<span class="nc" id="L1225">        int cnt = 0;</span>
<span class="nc" id="L1226">        Card up = getSafe(p, rr - 1, cc);</span>
<span class="nc" id="L1227">        Card down = getSafe(p, rr + 1, cc);</span>
<span class="nc bnc" id="L1228" title="All 4 branches missed.">        if (up != null &amp;&amp; up.name != null) {</span>
<span class="nc" id="L1229">            String n = up.name.toLowerCase();</span>
<span class="nc bnc" id="L1230" title="All 4 branches missed.">            if (n.equals(&quot;storehouse&quot;) || n.equals(&quot;abbey&quot;))</span>
<span class="nc" id="L1231">                cnt++;</span>
        }
<span class="nc bnc" id="L1233" title="All 4 branches missed.">        if (down != null &amp;&amp; down.name != null) {</span>
<span class="nc" id="L1234">            String n = down.name.toLowerCase();</span>
<span class="nc bnc" id="L1235" title="All 4 branches missed.">            if (n.equals(&quot;storehouse&quot;) || n.equals(&quot;abbey&quot;))</span>
<span class="nc" id="L1236">                cnt++;</span>
        }
<span class="nc" id="L1238">        return cnt;</span>
    }

    // ---------- Replenish ----------
    private void replenish(Player p) {
<span class="nc bnc" id="L1243" title="All 4 branches missed.">        if (p.flags != null &amp;&amp; p.flags.remove(&quot;NO_REPLENISH_ONCE&quot;)) {</span>
<span class="nc" id="L1244">            p.sendMessage(&quot;You cannot replenish your hand this turn (Fraternal Feuds).&quot;);</span>
<span class="nc" id="L1245">            return;</span>
        } else {
<span class="nc" id="L1247">            int handTarget = 3 + p.progressPoints;</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">            while (p.handSize() &lt; handTarget) {</span>
<span class="nc" id="L1249">                p.sendMessage(&quot;PROMPT: Replenish - choose draw stack [1-4]:&quot;);</span>
<span class="nc" id="L1250">                int which = readInt(p.receiveMessage(), 1);</span>
<span class="nc" id="L1251">                Vector&lt;Card&gt; stack = stackBy(which);</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">                if (stack.isEmpty()) {</span>
                    // advance circularly until any non-empty
<span class="nc" id="L1254">                    int tries = 0;</span>
                    do {
<span class="nc" id="L1256">                        which = 1 + (which % 4);</span>
<span class="nc" id="L1257">                        stack = stackBy(which);</span>
<span class="nc" id="L1258">                        tries++;</span>
<span class="nc bnc" id="L1259" title="All 4 branches missed.">                    } while (stack.isEmpty() &amp;&amp; tries &lt;= 4);</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">                    if (stack.isEmpty()) {</span>
<span class="nc" id="L1261">                        p.sendMessage(&quot;All stacks empty.&quot;);</span>
<span class="nc" id="L1262">                        break;</span>
                    }
                }
<span class="nc" id="L1265">                p.addToHand(stack.remove(0));</span>
<span class="nc" id="L1266">            }</span>
        }
<span class="nc" id="L1268">    }</span>

    private Vector&lt;Card&gt; stackBy(int n) {
<span class="nc bnc" id="L1271" title="All 5 branches missed.">        switch (n) {</span>
            case 1:
<span class="nc" id="L1273">                return Card.drawStack1;</span>
            case 2:
<span class="nc" id="L1275">                return Card.drawStack2;</span>
            case 3:
<span class="nc" id="L1277">                return Card.drawStack3;</span>
            case 4:
<span class="nc" id="L1279">                return Card.drawStack4;</span>
        }
<span class="nc" id="L1281">        return Card.drawStack1;</span>
    }

    private int readInt(String s, int def) {
        try {
<span class="nc" id="L1286">            return Integer.parseInt(s.trim());</span>
<span class="nc" id="L1287">        } catch (Exception e) {</span>
<span class="nc" id="L1288">            return def;</span>
        }
    }

    // ---------- Exchange (with Parish Hall discount) ----------
    private void exchangePhase(Player p) {
<span class="nc" id="L1294">        int limit = 3 + p.progressPoints;</span>
<span class="nc bnc" id="L1295" title="All 2 branches missed.">        if (p.handSize() &lt; limit) {</span>
<span class="nc" id="L1296">            broadcast(&quot;Exchange: hand below limit; skipping.&quot;);</span>
<span class="nc" id="L1297">            return;</span>
        }

<span class="nc" id="L1300">        p.sendMessage(&quot;PROMPT: Exchange a card? (Y/N)&quot;);</span>
<span class="nc" id="L1301">        String ans = p.receiveMessage();</span>
<span class="nc bnc" id="L1302" title="All 4 branches missed.">        if (ans == null || !ans.trim().toUpperCase().startsWith(&quot;Y&quot;))</span>
<span class="nc" id="L1303">            return;</span>

<span class="nc" id="L1305">        p.sendMessage(&quot;PROMPT: Enter card name to put under a stack:&quot;);</span>
<span class="nc" id="L1306">        String nm = p.receiveMessage();</span>
<span class="nc" id="L1307">        Card chosen = p.removeFromHandByName(nm);</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">        if (chosen == null) {</span>
<span class="nc" id="L1309">            p.sendMessage(&quot;Not in hand.&quot;);</span>
<span class="nc" id="L1310">            return;</span>
        }

<span class="nc" id="L1313">        p.sendMessage(&quot;PROMPT: Choose stack [1-4] to put it under:&quot;);</span>
<span class="nc" id="L1314">        int st = readInt(p.receiveMessage(), 1);</span>
<span class="nc" id="L1315">        Vector&lt;Card&gt; stack = stackBy(st);</span>
<span class="nc" id="L1316">        stack.add(chosen);</span>

<span class="nc" id="L1318">        boolean hasParish = p.flags.contains(&quot;PARISH&quot;);</span>
<span class="nc bnc" id="L1319" title="All 2 branches missed.">        int searchCost = hasParish ? 1 : 2;</span>

<span class="nc" id="L1321">        p.sendMessage(&quot;PROMPT: Choose Random draw (R) or Search (S, costs &quot; + searchCost + &quot; any)?&quot;);</span>
<span class="nc" id="L1322">        String mode = p.receiveMessage();</span>
<span class="nc bnc" id="L1323" title="All 4 branches missed.">        if (mode != null &amp;&amp; mode.trim().toUpperCase().startsWith(&quot;S&quot;)) {</span>
            // Pay 1 (with Parish) or 2 (normal) resources of the player's choice
<span class="nc bnc" id="L1325" title="All 2 branches missed.">            if (p.totalAllResources() &lt; searchCost) {</span>
<span class="nc" id="L1326">                p.sendMessage(&quot;Not enough resources to search.&quot;);</span>
<span class="nc" id="L1327">                return;</span>
            }
<span class="nc bnc" id="L1329" title="All 2 branches missed.">            for (int i = 0; i &lt; searchCost; i++) {</span>
<span class="nc" id="L1330">                p.sendMessage(&quot;PROMPT: Discard resource #&quot; + (i + 1) + &quot; [Brick|Grain|Lumber|Wool|Ore|Gold]:&quot;);</span>
<span class="nc" id="L1331">                p.removeResource(p.receiveMessage(), 1);</span>
            }

<span class="nc bnc" id="L1334" title="All 2 branches missed.">            if (stack.isEmpty()) {</span>
<span class="nc" id="L1335">                p.sendMessage(&quot;That stack is empty.&quot;);</span>
<span class="nc" id="L1336">                return;</span>
            }
<span class="nc" id="L1338">            p.sendMessage(&quot;Stack contains (top..bottom):&quot;);</span>
<span class="nc bnc" id="L1339" title="All 2 branches missed.">            for (Card c : stack)</span>
<span class="nc" id="L1340">                p.sendMessage(&quot; - &quot; + c.name);</span>
<span class="nc" id="L1341">            p.sendMessage(&quot;PROMPT: Type exact name to take:&quot;);</span>
<span class="nc" id="L1342">            String take = p.receiveMessage();</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">            for (int i = 0; i &lt; stack.size(); i++) {</span>
<span class="nc bnc" id="L1344" title="All 2 branches missed.">                if (stack.get(i).name.equalsIgnoreCase(take)) {</span>
<span class="nc" id="L1345">                    p.addToHand(stack.remove(i));</span>
<span class="nc" id="L1346">                    return;</span>
                }
            }
<span class="nc" id="L1349">            p.sendMessage(&quot;Not found; no card taken.&quot;);</span>
<span class="nc" id="L1350">        } else {</span>
            // Random draw (top of chosen stack)
<span class="nc bnc" id="L1352" title="All 2 branches missed.">            if (stack.isEmpty()) {</span>
<span class="nc" id="L1353">                p.sendMessage(&quot;That stack is empty.&quot;);</span>
<span class="nc" id="L1354">                return;</span>
            }
<span class="nc" id="L1356">            p.addToHand(stack.remove(0));</span>
        }
<span class="nc" id="L1358">    }</span>

    // ---------- Misc ----------
    private void broadcast(String s) {
        // send to each player
<span class="fc bfc" id="L1363" title="All 2 branches covered.">        for (Player p : players) {</span>
<span class="pc bpc" id="L1364" title="1 of 2 branches missed.">            if (p != null) {</span>
<span class="fc" id="L1365">                p.sendMessage(s);</span>
            }
<span class="fc" id="L1367">        }</span>
<span class="fc" id="L1368">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>